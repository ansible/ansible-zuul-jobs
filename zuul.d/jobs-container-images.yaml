---
- job:
    name: ansible-buildset-registry
    description: |
      Starts a buildset registry which interacts with the intermediate
      CI registry to share speculative container images between
      projects.

      Configure any jobs which require the use of a buildset registry
      to depend on this job using the "dependencies" job attribute.

      This job will pause after starting the registry so that it is
      available to any jobs which depend on it.  Once all such jobs
      are complete, this job will finish.
    pre-run: playbooks/buildset-registry/pre.yaml
    run: playbooks/buildset-registry/run.yaml
    post-run: playbooks/buildset-registry/post.yaml
    requires: container-image
    nodeset: ubuntu-bionic-1vcpu
    vars:
      container_command: docker

- job:
    name: ansible-build-container-image
    description: |
      This is a parent for an image build job which expects a
      buildset registry to be running and pulls images from the
      intermediate registry into it.  It mostly exists so that
      the intermediate registry secret need not be supplied to the
      image build playbook.
    parent: ansible-buildset-registry
    run: playbooks/container-image/run.yaml
    dependencies:
      - name: ansible-buildset-registry
        soft: true
    provides: container-image
    nodeset: ubuntu-bionic-1vcpu
    vars:
      container_command: podman
