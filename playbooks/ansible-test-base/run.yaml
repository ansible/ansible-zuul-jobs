---
- hosts: controller
  tasks:
    - when: ansible_test_collections | default(False)
      block:
        - name: Copy the galaxy.yml on the controller
          fetch:
            src: "{{ ansible_test_location }}/galaxy.yml"
            dest: '{{ zuul.executor.work_root }}/tmp_fetch'
          register: _fetch
        - name: Load information from galaxy.yml
          include_vars:
            file: '{{ _fetch.dest }}'
            name: galaxy_info

    - name: Enable FIPS mode
      become: true
      shell: fips-mode-setup --enable

    - name: Update /etc/default/grub
      become: true
      shell: sed -ie 's|GRUB_CMDLINE_LINUX_DEFAULT=\"\(.*\)\"|GRUB_CMDLINE_LINUX_DEFAULT=\"\1 fips=1\"|' /etc/default/grub

    - name: Rebuild grub.cfg file
      become: true
      shell: grub2-mkconfig -o /boot/grub2/grub.cfg

    - name: Reboot server for FIPS mode
      become: true
      reboot:
        reboot_timeout: 1800

    - name: Run start-zuul-console role
      include_role:
        name: start-zuul-console

    - name: Ensure FIPS mode is enabled
      become: true
      shell: fips-mode-setup --check

    - name: Run ansible-test
      import_role:
        name: ansible-test
      vars:
        ansible_test_test_command: "{{ ansible_test_command }}"
        ansible_test_location: "{{ ansible_user_dir }}/{{ zuul.projects[ansible_collections_repo].src_dir }}"
        ansible_test_git_branch: "{{ zuul.projects['github.com/ansible/ansible'].checkout }}"
        ansible_test_ansible_path: "{{ ansible_user_dir }}/{{ zuul.projects['github.com/ansible/ansible'].src_dir }}"
        ansible_test_collection_namespace: "{{ ansible_test_collections|ternary(galaxy_info.namespace, '') }}"
        ansible_test_collection_name: "{{ ansible_test_collections|ternary(galaxy_info.name, '') }}"
