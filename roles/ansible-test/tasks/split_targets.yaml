---
- name: List the targets
  args:
    chdir: "{{ _test_location }}"
    executable: /bin/bash
  environment: "{{ ansible_test_environment | default({}) }}"
  shell: "source {{ ansible_test_venv_path }}/bin/activate; {{ ansible_test_executable }} {{ ansible_test_test_command }} {{ ansible_test_options }} --list {{ ansible_test_integration_targets }} 2>&1|grep -v WARNING"
  register: ansible_test_targets
  failed_when: ansible_test_targets.rc not in [0, 1]
- set_fact:
    number_entries: "{{ ansible_test_targets.stdout_lines|length|unique }}"
# Slow tests tend to be closely related.  Hash the names to produce a repeatable
# list that avoids bringing those tests all into one group
- set_fact:
    _hashed_targets: []
- set_fact:
    _hashed_targets: "{{ ( _hashed_targets + [ { 'name': item, 'hash': (item | hash('md5')) } ] }}"
  loop: '{{ ansible_test_targets.stdout_lines|unique }}'
- set_fact:
    sorted_test_targets: "{{ _hashed_targets | sort(attribute='hash') | map(attribute='name') | list }}"
# Distribute test targets evenly between workers
- set_fact:
    targets_to_test: "{{ targets_to_test | default([]) + [ sorted_test_targets[item] ] }}"
  when: item % ansible_test_split_in == ansible_test_do_number|int - 1
  loop: "{{ range(0,number_entries|int)|list }}"
- set_fact:
    _integration_targets: "{{ targets_to_test | default([]) | join(' ') }}"
- debug:
    msg: "Do roles: '{{ _integration_targets }}'"
